
/**
 * @fileoverview Firestore Security Rules for HackEval application.
 *
 * Core Philosophy:
 * This ruleset prioritizes authorization independence by denormalizing data, allowing for simpler and more performant rules.
 * It leverages Anonymous Authentication for jury members, with access primarily governed by the Firebase Auth service.
 * Data validation is relaxed to allow for rapid prototyping, focusing on authorization and relational integrity.
 *
 * Data Structure:
 * - /teams/{teamId}: Stores information about each team.
 * - /scores/{teamId}: Stores scores given to a team by jury members.
 * - /juries/{juryId}: Stores information about jury members.
 * - /appConfig/loginBackground: Stores configuration for the app, like the login background URL.
 *
 * Key Security Decisions:
 * - Jury member access to scoring is granted via Anonymous Authentication, with no reliance on custom claims or complex role hierarchies.
 * - Write operations to the `/scores/{teamId}` collection happen with the `request.auth.uid` parameter.
 * - No user listing is allowed for any collection.
 *
 * Denormalization for Authorization:
 * - The `/scores/{teamId}` collection includes the `teamId`, allowing direct association between scores and teams without needing to perform `get()` operations.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to team data.
     * @path /teams/{teamId}
     * @allow (read) Allow any authenticated user to read team information.
     * @allow (list) Allow any authenticated user to list team information.
     * @allow (write) Allow any authenticated user to write.
     */
    match /teams/{teamId} {
      allow read, list, write: if isSignedIn();
    }

    /**
     * @description Grants jury members (via anonymous auth) access to create, read, update and delete scores.
     * @path /scores/{teamId}
     * @allow (read, list) Allow any authenticated user to read scores.
     * @allow (write) Allow any authenticated user to write scores.
     */
    match /scores/{teamId} {
       allow read, list, write: if isSignedIn();
    }

    /**
     * @description Grants access to jury member data.
     * @path /juries/{juryId}
     * @allow (read, list) Publicly readable for jury selection on login.
     * @allow (write) Only authenticated users (admins) can modify jury data.
     */
    match /juries/{juryId} {
      allow read, list: if true;
      allow write: if isSignedIn();
    }

    /**
     * @description Grants access to app configuration data.
     * @path /appConfig/{docId}
     * @allow (read, list) Publicly readable for login background.
     * @allow (write) Allow any authenticated user to write. (Admin check is done in UI, not rules)
     */
    match /appConfig/{docId} {
      allow read, list: if true;
      allow write: if isSignedIn();
    }


    // Helper function to determine if the user is signed in.
    function isSignedIn() {
      return request.auth != null;
    }
  }
}
