
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is signed in.
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to check if a user is an admin.
    // In this app, an admin is just a signed-in user.
    // UI-level checks prevent non-admins from reaching admin actions.
    function isAdmin() {
      return isSignedIn();
    }
    
    // Anyone can read the list of events for the login page
    match /events/{eventId} {
      allow read, list: if true;
      allow write: if isAdmin(); // Only admins can create/update events

      /**
       * Teams Collection:
       * - Admins can read, list, create, update, and delete teams.
       * - Juries (any signed-in user) can read and list teams to evaluate them.
       */
      match /teams/{teamId} {
        allow read, list: if isSignedIn();
        allow write: if isAdmin();
      }

      /**
       * Scores Collection:
       * - Admins can read all scores for the dashboard.
       * - Juries (any signed-in user) can read scores to see if they've already voted.
       * - Juries can create and update their own panel's score, but not others'.
       * - Admins can delete scores when deleting a team.
       */
      match /scores/{teamId} {
        allow read: if isSignedIn();
        allow create: if isSignedIn();
        // Allow a jury to update ONLY their panel's data and the avgScore, 
        // or allow an admin to update other fields.
        allow update: if isSignedIn() && (
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['panel1', 'avgScore']) ||
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['panel2', 'avgScore']) ||
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['panel3', 'avgScore']) ||
          (isAdmin() && request.resource.data.diff(resource.data).hasAny(['avgScore', 'consolidatedFeedback', 'panel1', 'panel2', 'panel3']))
        );
        // Allow admins to delete.
        allow delete: if isAdmin();
      }

      /**
       * Juries Collection:
       * - Anyone can read/list juries for the login dropdown for a specific event.
       * - Only admins can create, update, or delete jury members.
       */
      match /juries/{juryId} {
        allow read, list: if true;
        allow write: if isAdmin();
      }

      /**
       * EvaluationCriteria Collection:
       * - Juries (signed-in users) can read the criteria to build the form.
       * - Only admins can change which criteria are active.
       */
      match /evaluationCriteria/{criterionId} {
        allow read, list: if true;
        allow write: if isAdmin();
      }
    }

    /**
     * AppConfig Collection:
     * - Anyone can read the config (e.g., for the login background).
     * - Only admins can write to the config.
     */
    match /appConfig/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
